
# AdvancedSpider_Gwen 项目开发文档

## 项目概述

实现了多足生物运动学、IK（反向运动学）系统、以及流畅的角色控制体验。

## 项目架构

### 目录结构

```
Assets/AdvancedSpider_Gwen/
├── Script/           # 核心脚本文件
│   ├── Player/       # 玩家角色相关脚本
│   ├── Controller/   # 输入控制系统
│   ├── IK/          # 反向运动学系统
│   ├── Scan/        # 环境扫描系统
│   ├── Cam/         # 摄像机系统
│   └── Extension/   # 扩展工具类
├── Scene/            # 游戏场景
├── Prefab/          # 预制体
├── Model/           # 3D模型资源
├── Material/        # 材质资源
└── Sound/           # 音频资源
```

## 核心系统设计

### 1. 角色控制系统 (Player3D.cs)

#### 功能特性

- **物理基础移动**: 基于加速度和摩擦力的平滑移动系统
- **弧形射线检测**: 使用ArcCast进行地形适应
- **速度估算**: 动态计算最大速度限制
- **旋转控制**: 支持手柄右摇杆控制视角旋转

#### 技术实现

```csharp
// 速度计算系统
void ApplyAcceleration()
{
    Vector2 stickL = controller.StickL;
    if (stickL != Vector2.zero)
        velocityNoAdd += Time.fixedDeltaTime * new Vector2(
            accelerationSide, 
            stickL.y > 0 ? accelerationForward : accelerationBack
        ) * stickL;
}

// 弧形射线检测
if (PhysicsExtension.ArcCast(transform.position, 
    Quaternion.LookRotation(worldVelocity, arcTransformRotation.up), 
    arcAngle, arcRadius, arcResolution, arcLayer, out RaycastHit hit))
{
    transform.position = hit.point;
    transform.MatchUp(hit.normal);
}
```

### 2. 蜘蛛运动系统 (Spider.cs)

#### 核心算法

- **轨道更新系统**: 两种更新方法（腿部距离法和评分法）
- **步行动画**: 基于时间的腿部移动协调
- **地形适应**: 实时计算腿部目标位置
- **音效系统**: 动态脚步声播放

#### 步行动画实现

```csharp
IEnumerator Step(int idx)
{
    float t = 0, progress;
    Transform target = targets[idx];
    Transform orbit = orbits[idx];
    Transform leg = legs[idx];

    while (t < stepTime)
    {
        t += Time.deltaTime;
        progress = Mathf.Clamp01(t / stepTime);
    
        // 计算起始和结束位置
        Vector3 startPos = leg.TransformPoint(targetStartPosProj);
        (Vector3 endPos, Quaternion endRot) = EndStep(orbit);
    
        // 插值更新位置和旋转
        target.position = Vector3.Lerp(startPos, endPos, progress);
        target.position += stepHeight * player3D.SpeedProgress * 
                          stepHeightCurve.Evaluate(progress) * leg.up;
    
        target.rotation = Quaternion.Lerp(startRot, endRot, progress);
    
        yield return new WaitForEndOfFrame();
    }
}
```

### 3. 跳跃系统 (PlayerJump.cs)

#### 功能特性

- **多重跳跃**: 支持空中跳跃
- **重力模拟**: 自定义重力系统
- **着陆预测**: 提前计算着陆点
- **腿部协调**: 跳跃时腿部目标点动态调整

#### 跳跃物理

```csharp
void ApplyGravity()
{
    velocity += gravityForce * Time.deltaTime;
}

void ApplyFriction()
{
    velocity *= (1 - friction * Time.deltaTime);
}
```

### 4. IK系统 (IK.cs)

#### 技术特点

- **角度预计算**: 预先计算不同角度的腿部长度
- **目标匹配**: 自动调整腿部角度以匹配目标位置
- **平滑插值**: 使用插值实现平滑的角度变化

#### IK算法实现

```csharp
void MatchTarget()
{
    Vector3 toTarget = target.position - transform.position;
    float dstToTarget = toTarget.magnitude;
  
    // 设置角度
    SetAngle(FindAngle(dstToTarget));
  
    // 朝向目标
    Vector3 up = Vector3.Cross(toTarget, dir.right);
    transform.rotation = Quaternion.LookRotation(toTarget, up);
  
    // 腿部旋转校正
    float angle = Vector3.SignedAngle(transform.forward, 
                                     feet.position - transform.position, 
                                     transform.right);
    transform.Rotate(-angle, 0, 0);
}
```

### 5. 环境扫描系统 (ScanArchimedeanSpiral.cs)

#### 扫描算法

- **阿基米德螺旋**: 使用螺旋模式进行环境探测
- **射线投射**: 结合ArcCast进行地形检测
- **权重系统**: 基于距离的扫描点权重计算

#### 螺旋扫描实现

```csharp
List<(Vector3 pos, Quaternion rot, float weight)> Scan(bool gizmo = false)
{
    for (int i = 1; i <= nbPoints; i++)
    {
        float progress = (float)i / nbPoints;
        progress = Mathf.Pow(progress, progressPow);
    
        float o = Mathf.PI * 2 * nbTurns * progress;
        float r = radius * progress;
        Vector2 B = new Vector2(Mathf.Cos(o) * r, Mathf.Sin(o) * r);
    
        if (PhysicsExtension.ArcCast(pos, rot, arcAngle, AB.magnitude, 
                                    arcResolution, arcLayer, out RaycastHit hit))
        {
            points.Add((pos, rot * Quaternion.Euler(0, -angle, 0), weight));
        }
    }
}
```

### 6. 输入控制系统 (Controller.cs)

#### 设计模式

- **抽象基类**: 提供统一的输入接口
- **事件系统**: 使用UnityEvent处理按钮事件
- **摇杆支持**: 左右摇杆输入处理

#### 按钮事件系统

```csharp
public class Button
{
    bool isPressed = false;
    public UnityEvent OnPressDown = new UnityEvent();
    public UnityEvent OnPressUp = new UnityEvent();
  
    public bool IsPressed
    {
        set
        {
            if (isPressed == value) return;
        
            if (!isPressed && value)
                OnPressDown.Invoke();
        
            if (isPressed && !value)
                OnPressUp.Invoke();
            
            isPressed = value;
        }
    }
}
```

## 技术亮点

### 1. 物理系统

- **自定义重力**: 可调节的重力向量
- **摩擦力模拟**: 基于时间的摩擦力衰减
- **碰撞检测**: 弧形射线检测系统

### 2. 动画系统

- **程序化动画**: 基于物理的腿部运动
- **时间协调**: 多腿部协调的步行动画
- **曲线控制**: 使用AnimationCurve控制动画效果

### 3. 性能优化

- **预计算**: 角度-距离关系预计算
- **协程使用**: 使用协程管理复杂的时间序列
- **对象池**: 避免频繁的对象创建

## 开发流程

### 第一阶段：基础架构

1. 创建Player3D基础移动系统
2. 实现Controller输入抽象层
3. 建立基本的物理系统

### 第二阶段：蜘蛛运动

1. 开发Spider腿部协调系统
2. 实现轨道更新算法
3. 添加步行动画逻辑

### 第三阶段：高级功能

1. 集成IK系统
2. 实现跳跃机制
3. 添加环境扫描功能

### 第四阶段：优化完善

1. 音效系统集成
2. 性能优化
3. 调试和测试

## 使用说明

### 基本操作

- **左摇杆**: 控制角色移动
- **右摇杆**: 控制视角旋转
- **Y按钮**: 跳跃
- **A/B/X按钮**: 其他动作（可自定义）

### 参数调整

- `stepTime`: 步行动画时长
- `stepHeight`: 抬腿高度
- `jumpVelocityY`: 跳跃垂直速度
- `gravityForce`: 重力强度

## 扩展建议

### 1. 功能扩展

- 添加更多动作（爬墙、荡秋千等）
- 实现技能系统
- 添加粒子效果

### 2. 性能优化

- 实现LOD系统
- 添加对象池管理
- 优化射线检测算法

### 3. 工具开发

- 创建编辑器工具
- 添加调试可视化
- 实现性能监控

## 总结

AdvancedSpider_Gwen项目展示了现代游戏开发中复杂角色控制系统的实现方法。通过模块化设计、物理模拟、程序化动画等技术的结合，创造了一个具有真实感的蜘蛛侠角色控制系统。该项目为类似的生物角色开发提供了宝贵的技术参考和实现思路。

## 技术栈

- **游戏引擎**: Unity 2022.3 LTS
- **编程语言**: C#
- **核心算法**: IK系统、物理模拟、程序化动画
- **设计模式**: 组件模式、观察者模式、策略模式
- **性能优化**: 协程、预计算、对象池
